{{- $order := list "frontend" "frontendApi" "backendApi" "database" -}}
{{- $last := sub (len $order) 1 -}}
{{- $root := . -}}
{{- range $idx, $name := $order }}
{{- $svc := index $root.Values.service $name }}
{{- $workload := default dict (index $root.Values.workloads $name) }}
{{- $image := include "ocp-dog.image" (index $root.Values.images $name) }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ocp-dog.fullname" $root }}-{{ $svc.component }}
  labels:
    {{- include "ocp-dog.labels" $root | nindent 4 }}
    tier: {{ $svc.tier }}
spec:
  replicas: {{ index $root.Values.replicaCount $name }}
  selector:
    matchLabels:
      app: {{ $root.Values.app.name }}
      component: {{ $svc.component }}
  template:
    metadata:
      labels:
        app: {{ $root.Values.app.name }}
        component: {{ $svc.component }}
        tier: {{ $svc.tier }}
    spec:
      containers:
        - name: {{ default $svc.component $workload.containerName }}
          image: {{ $image }}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: {{ $svc.targetPort }}
              name: {{ default "http" $svc.portName }}
{{- with $workload.env }}
          env:
            {{- range . }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .configMapKey }}
              valueFrom:
                configMapKeyRef:
                  name: {{ include "ocp-dog.fullname" $root }}-config
                  key: {{ .configMapKey }}
              {{- else if .secretKey }}
              {{- $secretName := .secretName | default (printf "%s-%s" (include "ocp-dog.fullname" $root) (default "db" .secretNameSuffix)) }}
              valueFrom:
                secretKeyRef:
                  name: {{ $secretName }}
                  key: {{ .secretKey }}
              {{- end }}
            {{- end }}
{{- end }}
{{- with $workload.volumeMounts }}
          volumeMounts:
            {{- range . }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if .subPath }}
              subPath: {{ .subPath }}
              {{- end }}
              {{- if hasKey . "readOnly" }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
{{- end }}
{{- with $workload.readinessProbe }}
          readinessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ default "http" .port }}
            {{- if hasKey . "initialDelaySeconds" }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            {{- end }}
            {{- if hasKey . "periodSeconds" }}
            periodSeconds: {{ .periodSeconds }}
            {{- end }}
{{- end }}
{{- with $workload.livenessProbe }}
          livenessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ default "http" .port }}
            {{- if hasKey . "initialDelaySeconds" }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            {{- end }}
            {{- if hasKey . "periodSeconds" }}
            periodSeconds: {{ .periodSeconds }}
            {{- end }}
{{- end }}
{{- with $workload.volumes }}
      volumes:
        {{- range . }}
        - name: {{ .name }}
          {{- if .configMap }}
          configMap:
            name: {{ .configMap.name }}
          {{- else if .secret }}
          secret:
            secretName: {{ .secret.name }}
          {{- else if .persistentVolumeClaim }}
          persistentVolumeClaim:
            claimName: {{ .persistentVolumeClaim.claimName }}
          {{- else if .emptyDir }}
          emptyDir:
            {{- if .emptyDir.medium }}
            medium: {{ .emptyDir.medium }}
            {{- end }}
            {{- if .emptyDir.sizeLimit }}
            sizeLimit: {{ .emptyDir.sizeLimit }}
            {{- end }}
          {{- else }}
          emptyDir: {}
          {{- end }}
        {{- end }}
{{- end }}
{{- if lt $idx $last }}
---
{{- end }}
{{- end }}
