{{- $root := . -}}
{{- $workloads := list
  (dict
    "name" "frontend"
    "component" "frontend"
    "tier" "frontend"
    "replicas" $root.Values.replicaCount.frontend
    "image" (include "ocp-dog.image" $root.Values.images.frontend)
    "port" $root.Values.service.frontend.targetPort
    "portName" "http"
    "env" (list
      (dict "name" "FRONTEND_API_URL" "type" "config" "key" "FRONTEND_API_URL")
    )
    "readiness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 10 "periodSeconds" 10)
    "liveness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 30 "periodSeconds" 30)
  )
  (dict
    "name" "frontend-api"
    "component" "frontend-api"
    "tier" "api"
    "replicas" $root.Values.replicaCount.frontendApi
    "image" (include "ocp-dog.image" $root.Values.images.frontendApi)
    "port" $root.Values.service.frontendApi.targetPort
    "portName" "http"
    "env" (list
      (dict "name" "BACKEND_API_URL" "type" "config" "key" "BACKEND_API_URL")
    )
    "readiness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 10 "periodSeconds" 10)
    "liveness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 30 "periodSeconds" 30)
  )
  (dict
    "name" "backend-api"
    "component" "backend-api"
    "tier" "backend"
    "replicas" $root.Values.replicaCount.backendApi
    "image" (include "ocp-dog.image" $root.Values.images.backendApi)
    "port" $root.Values.service.backendApi.targetPort
    "portName" "http"
    "env" (list
      (dict "name" "DB_HOST" "type" "config" "key" "DB_HOST")
      (dict "name" "DB_NAME" "type" "config" "key" "DB_NAME")
      (dict "name" "DB_USER" "type" "secret" "key" "DB_USER" "secretSuffix" "db")
      (dict "name" "DB_PASS" "type" "secret" "key" "DB_PASS" "secretSuffix" "db")
    )
    "readiness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 15 "periodSeconds" 10)
    "liveness" (dict "path" "/healthz" "port" "http" "initialDelaySeconds" 45 "periodSeconds" 30)
  )
  (dict
    "name" "database"
    "component" "database"
    "tier" "database"
    "replicas" $root.Values.replicaCount.database
    "image" (include "ocp-dog.image" $root.Values.images.database)
    "port" $root.Values.service.database.port
    "portName" "tcp"
    "env" (list
      (dict "name" "POSTGRES_DB" "type" "config" "key" "DB_NAME")
      (dict "name" "POSTGRES_USER" "type" "secret" "key" "DB_USER" "secretSuffix" "db")
      (dict "name" "POSTGRES_PASSWORD" "type" "secret" "key" "DB_PASS" "secretSuffix" "db")
    )
  )
-}}
{{- $lastIndex := sub (len $workloads) 1 -}}
{{- range $idx, $workload := $workloads }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ocp-dog.fullname" $root }}-{{ $workload.name }}
  labels:
    {{- include "ocp-dog.labels" $root | nindent 4 }}
    tier: {{ $workload.tier }}
spec:
  replicas: {{ $workload.replicas }}
  selector:
    matchLabels:
      app: {{ $root.Values.app.name }}
      component: {{ $workload.component }}
  template:
    metadata:
      labels:
        app: {{ $root.Values.app.name }}
        component: {{ $workload.component }}
        tier: {{ $workload.tier }}
    spec:
      containers:
        - name: {{ $workload.component }}
          image: {{ $workload.image }}
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: {{ $workload.port }}
              name: {{ default "http" $workload.portName }}
{{- if $workload.env }}
          env:
            {{- range $env := $workload.env }}
            - name: {{ $env.name }}
              {{- if $env.value }}
              value: {{ $env.value | quote }}
              {{- else if eq $env.type "config" }}
              valueFrom:
                configMapKeyRef:
                  name: {{ include "ocp-dog.fullname" $root }}-config
                  key: {{ $env.key }}
              {{- else if eq $env.type "secret" }}
              {{- $secretSuffix := default "db" $env.secretSuffix -}}
              {{- $secretName := default (printf "%s-%s" (include "ocp-dog.fullname" $root) $secretSuffix) $env.secretName -}}
              valueFrom:
                secretKeyRef:
                  name: {{ $secretName }}
                  key: {{ $env.key }}
              {{- end }}
            {{- end }}
{{- end }}
{{- with $workload.readiness }}
          readinessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ default "http" .port }}
            {{- if .initialDelaySeconds }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            {{- end }}
            {{- if .periodSeconds }}
            periodSeconds: {{ .periodSeconds }}
            {{- end }}
{{- end }}
{{- with $workload.liveness }}
          livenessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ default "http" .port }}
            {{- if .initialDelaySeconds }}
            initialDelaySeconds: {{ .initialDelaySeconds }}
            {{- end }}
            {{- if .periodSeconds }}
            periodSeconds: {{ .periodSeconds }}
            {{- end }}
{{- end }}
{{- if lt $idx $lastIndex }}
---
{{- end }}
{{- end }}
